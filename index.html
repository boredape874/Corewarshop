<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지 - 커뮤니티 추가</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="container mx-auto max-w-md p-4">
        
        <!-- 로그인 패널 -->
        <div id="admin-login-panel" class="p-6 bg-white rounded-lg shadow-md">
            <h1 class="text-2xl font-bold text-center mb-6">관리자 로그인</h1>
            <div class="mb-4">
                <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                <input type="password" id="admin-password" class="w-full p-2 border border-gray-300 rounded-lg">
            </div>
            <button id="admin-login-btn" class="w-full px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-colors">
                로그인
            </button>
            <p id="admin-message" class="text-red-500 text-sm mt-3 text-center"></p>
        </div>

        <!-- 커뮤니티 추가 폼 (로그인 성공 시 보임) -->
        <div id="admin-form-panel" class="hidden">
            <h1 class="text-3xl font-bold text-center mb-6">새 커뮤니티 추가</h1>
            <div class="bg-white p-6 rounded-lg shadow-xl w-full">
                <form id="add-community-form">
                    <div class="mb-4">
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">카테고리</label>
                        <select id="category" name="category" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="" disabled selected>종류를 선택하세요</option>
                            <option value="오픈채팅">오픈채팅</option>
                            <option value="디스코드">디스코드</option>
                            <option value="웹사이트">웹사이트</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
                        <input type="text" id="title" name="title" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="예: 잼있는 코딩 스터디" required>
                    </div>
                    <div class="mb-4">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">내용</label>
                        <textarea id="description" name="description" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="예: 매일 함께 모여 코딩 문제를 풉니다." required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="imageUrl" class="block text-sm font-medium text-gray-700 mb-1">이미지 URL</label>
                        <input type="url" id="imageUrl" name="imageUrl" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="https://example.com/image.png" required>
                    </div>
                    <div class="mb-4">
                        <label for="link" class="block text-sm font-medium text-gray-700 mb-1">참여 링크 (카카오톡, 디스코드, 웹사이트)</label>
                        <input type="url" id="link" name="link" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="https://open.kakao.com/..." required>
                    </div>
                    <button type="submit" id="submit-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        저장
                    </button>
                    <p id="form-message" class="text-green-600 text-sm mt-3 text-center"></p>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // Your web app's Firebase configuration (UPDATED)
        const firebaseConfig = {
            apiKey: "AIzaSyClzOguU5EBO6ooc9SJsL_1E2C6eVvO3s8",
            authDomain: "bedrocklistkr.firebaseapp.com",
            projectId: "bedrocklistkr",
            storageBucket: "bedrocklistkr.firebasestorage.app",
            messagingSenderId: "471153867181",
            appId: "1:471153867181:web:41a7445930107755930924"
        };

        let app;
        try {
            app = initializeApp(firebaseConfig);
        } catch (e) {
            console.error("1. Firebase App 초기화 실패:", e);
            document.getElementById('admin-message').textContent = 'Firebase 설정 오류. 콘솔 확인(단계 1).';
        }
        
        let db, auth;
        let userId = null;
        const firestoreCollectionPath = 'communities';

        // *** 관리자 비밀번호 설정 ***
        const ADMIN_PASSWORD = "admin"; // <-- 여기서 관리자 비밀번호 변경

        // DOM 요소
        const adminLoginPanel = document.getElementById('admin-login-panel');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminMessage = document.getElementById('admin-message');
        
        const adminFormPanel = document.getElementById('admin-form-panel');
        const addForm = document.getElementById('add-community-form');
        const submitBtn = document.getElementById('submit-btn');
        const formMessage = document.getElementById('form-message');

        // 관리자 로그인 로직
        adminLoginBtn.addEventListener('click', () => {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                adminLoginPanel.classList.add('hidden');
                adminFormPanel.classList.remove('hidden');
                adminMessage.textContent = '';
                
                // 로그인이 성공하면 Firebase 초기화 시작
                initializeFirebase();
            } else {
                adminMessage.textContent = '비밀번호가 일치하지 않습니다.';
            }
        });

        // 새 커뮤니티 추가 (Form Submit)
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                formMessage.textContent = '데이터베이스 연결을 확인해주세요.';
                return;
            }

            const formData = new FormData(addForm);
            const data = {
                category: formData.get('category'),
                title: formData.get('title'),
                description: formData.get('description'),
                imageUrl: formData.get('imageUrl'),
                link: formData.get('link'),
                createdAt: new Date()
            };

            if (!data.category || !data.title || !data.description || !data.imageUrl || !data.link) {
                formMessage.textContent = '모든 필드를 입력해주세요.';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '저장 중...';
            formMessage.textContent = '';

            try {
                await addDoc(collection(db, firestoreCollectionPath), data);
                formMessage.textContent = `'${data.title}'이(가) 성공적으로 추가되었습니다!`;
                formMessage.classList.remove('text-red-500');
                formMessage.classList.add('text-green-600');
                addForm.reset();
                
            } catch (error) {
                console.error("데이터 추가 오류: ", error);
                formMessage.textContent = '저장에 실패했습니다. (Firestore 규칙 문제일 수 있음)';
                formMessage.classList.remove('text-green-600');
                formMessage.classList.add('text-red-500');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '저장';
            }
        });

        // Firebase 서비스 초기화 및 인증
        async function initializeFirebase() {
            if (!app) {
                adminMessage.textContent = 'Firebase 앱 초기화 실패로 진행 불가.';
                return;
            }

            try {
                // 2. Auth 서비스 초기화
                auth = getAuth(app);
                await setPersistence(auth, inMemoryPersistence);
                
                // 3. Firestore 서비스 초기화
                db = getFirestore(app);
                setLogLevel('Debug');
                
                // 4. 익명 인증
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("익명 인증 성공:", user.uid);
                        userId = user.uid;
                        adminMessage.textContent = '로그인 및 Firebase 연동 성공!';
                        adminMessage.classList.remove('text-red-500');
                        adminMessage.classList.add('text-green-600');
                    } else {
                        console.log("인증된 사용자가 없습니다.");
                        userId = null;
                        adminMessage.textContent = '인증 실패. (Anonymous 인증 활성화 확인)';
                        adminMessage.classList.add('text-red-500');
                        adminMessage.classList.remove('text-green-600');
                    }
                });
                
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase 서비스 초기화 또는 익명 인증 오류:", error);
                adminMessage.textContent = `Firebase 연동 중 오류 발생: ${error.message}. 콘솔 확인.`;
                adminMessage.classList.add('text-red-500');
                adminMessage.classList.remove('text-green-600');
            }
        }
    </script>
</body>
</html>


